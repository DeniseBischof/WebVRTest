<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Merry Christmas VR</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; overflow:hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    #ui {
      position: fixed; inset: 0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap: 14px;
      background: radial-gradient(ellipse at center, rgba(0,0,0,.45), rgba(0,0,0,.92));
      color:#fff; text-align:center; padding: 24px;
      z-index: 10;
    }
    #ui h1 { margin:0; font-size: 22px; font-weight: 800; }
    #ui p { margin:0; opacity:.85; max-width: 520px; line-height:1.35; }
    #start {
      border: 0; border-radius: 999px;
      padding: 12px 18px; font-size: 16px; font-weight: 800;
      cursor: pointer;
    }
    #hint { font-size: 13px; opacity: .75; }
    #tiny { font-size: 12px; opacity: .6; }
  </style>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>

  <script>
    async function goFullscreen() {
      const el = document.documentElement;
      if (el.requestFullscreen) return el.requestFullscreen();
      if (el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
    }

    async function requestMotionPermissionIfNeeded() {
      const D = window.DeviceOrientationEvent;
      if (D && typeof D.requestPermission === "function") {
        const res = await D.requestPermission();
        if (res !== "granted") throw new Error("Motion permission not granted");
      }
    }

    AFRAME.registerComponent('snow', {
      schema: {
        count: {type: 'int', default: 900},
        area:  {type: 'number', default: 18},   // width/depth around camera
        top:   {type: 'number', default: 8},    // spawn height above camera
        bottom:{type: 'number', default: -2},   // recycle below camera
        speedMin: {type: 'number', default: 0.6},
        speedMax: {type: 'number', default: 1.8},
        size:  {type: 'number', default: 0.06}
      },
      init() {
        const d = this.data;
        this.rig = document.querySelector('#rig') || this.el.sceneEl.camera?.el;

        // geometry
        this.positions = new Float32Array(d.count * 3);
        this.speeds = new Float32Array(d.count);

        const rand = (a,b)=>a+Math.random()*(b-a);

        for (let i=0;i<d.count;i++){
          this.positions[i*3+0] = rand(-d.area/2, d.area/2);
          this.positions[i*3+1] = rand(d.bottom, d.top);
          this.positions[i*3+2] = rand(-d.area/2, d.area/2);
          this.speeds[i] = rand(d.speedMin, d.speedMax);
        }

        this.geometry = new THREE.BufferGeometry();
        this.geometry.setAttribute('position', new THREE.BufferAttribute(this.positions, 3));

        this.material = new THREE.PointsMaterial({
          size: d.size,
          sizeAttenuation: true,
          transparent: true,
          opacity: 0.9
        });

        this.points = new THREE.Points(this.geometry, this.material);
        this.el.setObject3D('snowPoints', this.points);

        this._tmp = new THREE.Vector3();
      },
      tick(time, delta) {
        const d = this.data;
        const dt = Math.min(delta, 33) / 1000;

        const rig = this.rig && (this.rig.object3D || this.el.sceneEl.camera);
        if (rig) {
          rig.getWorldPosition(this._tmp);
          this.points.position.x = this._tmp.x;
          this.points.position.y = this._tmp.y;
          this.points.position.z = this._tmp.z;
        }

        const p = this.positions;
        for (let i=0;i<d.count;i++){
          const idx = i*3;
          p[idx+1] -= this.speeds[i]*dt;

          // gentle sideways drift
          p[idx+0] += Math.sin((time*0.0005)+i)*0.002;
          p[idx+2] += Math.cos((time*0.0004)+i)*0.002;

          if (p[idx+1] < d.bottom) {
            p[idx+1] = d.top;
            p[idx+0] = (Math.random()-0.5)*d.area;
            p[idx+2] = (Math.random()-0.5)*d.area;
            this.speeds[i] = d.speedMin + Math.random()*(d.speedMax-d.speedMin);
          }
        }
        this.geometry.attributes.position.needsUpdate = true;
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      const ui = document.getElementById("ui");
      const btn = document.getElementById("start");

      btn.addEventListener("click", async () => {
        try { await requestMotionPermissionIfNeeded(); } catch (e) { console.warn(e); }
        try { await goFullscreen(); } catch(e) {}

        ui.style.display = "none";

        const scene = document.querySelector("a-scene");

        const bgm = document.querySelector("#bgm");
        try {
          if (bgm && bgm.components && bgm.components.sound) bgm.components.sound.playSound();
        } catch (e) { console.warn("Sound start failed", e); }

        try { scene && scene.enterVR && scene.enterVR(); } catch (e) {}

        setTimeout(() => {
          if (scene && scene.renderer) {
            scene.renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
          }
        }, 50);
      });
    });
  </script>
</head>

<body>
  <div id="ui">
    <h1>Cardboard VR ðŸŽ„</h1>
    <p>Tippe auf â€žStartâ€œ, setz das Handy in die Brille, und dreh dich langsam um.</p>
    <button id="start">Start</button>
    <div id="hint">Tipp: Bildschirmhelligkeit hochdrehen âœ¨</div>
    <div id="tiny">Wennâ€™s wackelt: Handy-Orientation-Lock aus.</div>
  </div>

  <a-scene
    vr-mode-ui="enabled: true"
    renderer="colorManagement: true; physicallyCorrectLights: false; antialias: true"
    embedded
  >
    <a-assets>
      <audio id="jinglebells" preload="auto" crossorigin="anonymous" src="https://upload.wikimedia.org/wikipedia/commons/4/4e/JingleBells-Instrumental-.ogg"></audio>
      <img id="giftIcon" crossorigin="anonymous" src="https://twemoji.maxcdn.com/v/latest/svg/1f381.svg">
      <img id="sparklesIcon" crossorigin="anonymous" src="https://twemoji.maxcdn.com/v/latest/svg/2728.svg">

    </a-assets>

    <a-sky color="#000000"></a-sky>

    <a-entity snow="count: 1000; area: 22; top: 10; bottom: -3; speedMin: 0.7; speedMax: 2.0; size: 0.06"></a-entity>

    <a-plane rotation="-90 0 0" width="50" height="50" color="#050505"
      material="shader: standard; roughness:1; metalness:0"
      position="0 -1.6 0"></a-plane>

    <a-entity id="rig" position="0 0 0">
      <a-camera
        position="0 0 0"
        look-controls="enabled: true"
        wasd-controls="enabled: false"
      >
        <a-entity
          position="0 0 -1"
          geometry="primitive: ring; radiusInner: 0.008; radiusOuter: 0.012"
          material="color: #ffffff; opacity: 0.55; shader: flat"
        ></a-entity>

        <a-entity id="bgm"
          sound="src: #jinglebells; autoplay: false; loop: true; volume: 0.5"></a-entity>
      </a-camera>
    </a-entity>

   <a-entity position="0 0 4" rotation="0 180 0">

  <!-- Soft glow behind the sign -->
  <a-plane width="4.2" height="2.0" color="#ffffff"
    material="shader: flat; opacity: 0.05; blending: additive"
    position="0 0 -0.12"
    animation="property: material.opacity; dir: alternate; dur: 1400; easing: easeInOutSine; loop: true; to: 0.10">
  </a-plane>

  <!-- White border (slightly bigger plane behind) -->
  <a-plane width="3.45" height="1.35" color="#ffffff"
    material="shader: flat; opacity: 0.95"
    position="0 0 -0.07"></a-plane>

  <!-- Red inner plate -->
  <a-plane width="3.25" height="1.15" color="#c1121f"
    material="shader: flat; opacity: 0.92"
    position="0 0 -0.06"></a-plane>

  <!-- Centered text group -->
  <a-entity position="0 0 0"
    animation__float="property: position; dir: alternate; dur: 1600; easing: easeInOutSine; loop: true; to: 0 0.05 0"
    animation__pulse="property: scale; dir: alternate; dur: 1200; easing: easeInOutSine; loop: true; to: 1.05 1.05 1.05"
  >

  <a-entity
    position="0 0.05 0"
    text="value: Merry Christmas; align: center; anchor: center; baseline: center; width: 7.5; color: #0b5d1e;"
    animation__float="property: position; dir: alternate; dur: 1600; easing: easeInOutSine; loop: true; to: 0 0.12 0"
    animation__pulse="property: scale; dir: alternate; dur: 1200; easing: easeInOutSine; loop: true; to: 1.06 1.06 1.06"
  ></a-entity>

  <a-entity position="0 -0.38 0">
    <a-image src="#giftIcon" width="0.35" height="0.35" position="-0.22 0 0"></a-image>
    <a-image src="#sparklesIcon" width="0.35" height="0.35" position="0.22 0 0" animation="property: rotation; dur: 3000; easing: linear; loop: true; to: 0 360 0">
  </a-image>


  </a-entity>

</a-entity>


    <a-entity light="type: ambient; intensity: 0.9"></a-entity>
  </a-scene>
</body>
</html>
